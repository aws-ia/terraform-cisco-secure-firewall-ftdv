# AWS GWLB Centralized Architecture setup with Cisco Secure Firewall in Multiple Spoke Environment

## Overview

Using this Terraform template, the following resources will be created:

### Service VPC

- Mgmt, Diag, Outside, Inside subnets per AZ
- One Gateway Load Balancer
- 2 Cisco Secure Firewall Threat Defense (FTD) as GWLB Targets
- 1 TGW subnet per AZ
- Default route in TGW subnet route table to Gateway Load Balancer Endpoint
- Gateway Load Balancer Endpoint (GWLBE) subnets per AZ
- Spoke VPC 1 subnet route in GWLBE to Transit Gateway
- Spoke VPC 2 subnet route in GWLBE to Transit Gateway

### Spoke VPC 1

- 1 Spoke VPC with 2 subnets in different AZ

### Spoke VPC 2

- 1 Spoke VPC with 2 subnets in different AZ

### Transit Gateway

- One Transit Gateway
- Attachments for Transit Gateway to service and the 2 spoke VPCs
- Transit Gateway routing table for each attachment

### Terraform for FMC configuration

All the configuration on the Firewall Management Center is done by using the Cisco FMC Terraform Provider. The following FMC configuration is an example making use of the evaluation license. If there are more than 2 FTDv instances deployed, additional "fmc_devices" resources need to be added in the "main.tf" file.

The FMC Terraform provider is used to configure the following on the FMC:

- FTD Device Registration
- Interface Configuration
- VTEP
- VNI Interface
- NAT rules for health check (conditional)
- Access Policy
- Access Rule to allow health check probe traffic (conditional)
- Inside subnet Gateway Network object

Note: After the deployment, a default route to the transit gateway needs to be added in the spoke subnet route table.

## Topology

![GWLB Multiple Spoke Architecture](../../images/multi_spoke.png)

## Prerequisites

Make sure you have the following:

- Terraform â€“ Learn how to download and set up [here](https://learn.hashicorp.com/terraform/getting-started/install.html).
- Programmatic access to AWS account with CLI - learn how to set up [here](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html).
- Service VPC with a subnet created
- A Keypair should be created on AWS and referenced here
- A Cisco Secure Firewall Management Center (FMC) in Service VPC with security groups attached allowing HTTPS traffic and traffic from Cisco Secure Firewall Threat Defense.

## Requirements

| Name | Version |
|------|---------|
| [terraform](#requirement_terraform) | >= 0.13.5 |
| [aws](#requirement_aws) | >= 2.7.0 |

## Providers

| Name | Version |
|------|---------|
| [aws](#provider_aws) | >= 2.7.0 |
| [time](#provider_time) | n/a |
| [CiscoDevNet/fmc](#provider_CiscoDevNet/fmc) | 1.4.8 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| [gwlb](#module_gwlb) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/gwlb | n/a |
| [gwlbe](#module_gwlbe) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/gwlbe | n/a |
| [instance](#module_instance) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/firewall_instance | n/a |
| [service_network](#module_service_network) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/network | n/a |
| [spoke_network1](#module_spoke_network1) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/network | n/a |
| [spoke_network2](#module_spoke_network2) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/network | n/a |
| [transitgateway1](#module_transitgateway1) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/transitgateway | n/a |
| [transitgateway2](#module_transitgateway2) | /Users/sameersingh/git_repos/terraform-aws-secure-firewall/modules/transitgateway | n/a |

## Resources

| Name | Type |
|------|------|
| time_sleep.wait_for_ftd | resource |
| fmc_security_zone.inside | resource |
| fmc_security_zone.outside | resource |
| fmc_security_zone.vni | resource |
| fmc_host_objects.aws_meta | resource |
| fmc_host_objects.inside_gw | resource |
| fmc_smart_license.license | resource |
| fmc_access_policies.access_policy | resource |
| fmc_access_rules.access_rule_1 | resource |
| fmc_ftd_nat_policies.nat_policy | resource |
| fmc_ftd_manualnat_rules.new_rule | resource |
| fmc_devices.device1 | resource |
| fmc_devices.device2 | resource |
| fmc_device_physical_interfaces.physical_interfaces00 | resource |
| fmc_device_physical_interfaces.physical_interfaces01 | resource |
| fmc_staticIPv4_route.route | resource |
| fmc_policy_devices_assignments.policy_assignment | resource |
| fmc_device_vtep.vtep_policies | resource |
| fmc_device_vni.vni | resource |
| fmc_ftd_deploy.ftd | resource |
| fmc_port_objects.http | data source |
| fmc_port_objects.ssh | data source |
| fmc_network_objects.any_ipv4 | data source |
| fmc_device_physical_interfaces.zero_physical_interface | data source |
| fmc_device_physical_interfaces.one_physical_interface | data source |
| fmc_devices.device | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| [availability_zone_count](#input_availability_zone_count) | Specified availability zone count. | `number` | `2` | no |
| [aws_access_key](#input_aws_access_key) | AWS ACCESS KEY | `string` | n/a | yes |
| [aws_secret_key](#input_aws_secret_key) | AWS SECRET KEY | `string` | n/a | yes |
| [create_fmc](#input_create_fmc) | Boolean value to create FMC or not | `bool` | `true` | no |
| [create_fmc_spoke1](#input_create_fmc_spoke1) | Boolean value to create FMC or not | `bool` | `true` | no |
| [create_fmc_spoke2](#input_create_fmc_spoke2) | Boolean value to create FMC or not | `bool` | `true` | no |
| [create_tgw1](#input_create_tgw1) | n/a | `bool` | n/a | yes |
| [create_tgw2](#input_create_tgw2) | n/a | `bool` | n/a | yes |
| [diag_subnet_cidr](#input_diag_subnet_cidr) | List of diagnostic Subnet CIDR. | `list(string)` | `[]` | no |
| [diag_subnet_name](#input_diag_subnet_name) | Specified diagnostic subnet names | `list(string)` | `[]` | no |
| [domainUUID](#input_domainUUID) | Domain UUID of the cdFMC | `string` | n/a | yes |
| [fmc_ip](#input_fmc_ip) | List of FMCv IPs. | `string` | `""` | no |
| [fmc_mgmt_interface_sg](#input_fmc_mgmt_interface_sg) | Specified multiple times for each ingress rule. | `list(object({<br>    from_port   = number<br>    protocol    = string<br>    to_port     = number<br>    cidr_blocks = list(string)<br>    description = string<br>  }))` | `[<br>  {<br>    "cidr_blocks": [<br>      "0.0.0.0/0"<br>    ],<br>    "description": "FMC Mgmt Interface SG",<br>    "from_port": 0,<br>    "protocol": "-1",<br>    "to_port": 0<br>  }<br>]` | no |
| [fmc_nat_id](#input_fmc_nat_id) | FMC Registration NAT ID | `string` | n/a | yes |
| [fmc_password](#input_fmc_password) | n/a | `string` | n/a | yes |
| [fmc_username](#input_fmc_username) | n/a | `string` | n/a | yes |
| [ftd_diag_ip](#input_ftd_diag_ip) | List of FTD Diagnostic IPs. | `list(string)` | `[]` | no |
| [ftd_inside_gw](#input_ftd_inside_gw) | Inside subnet Gateway | `list(string)` | n/a | yes |
| [ftd_inside_ip](#input_ft
